{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Parameters" : {
      "RedHatAWSAccountID": {
        "Description": "AWS Account ID",
        "Type": "Number",
        "Default": "710019948333"
      },
      "ROSAVersion": {
        "Description": "ROSA version",
        "Type": "Number"
      },
      "Prefix": {
        "Description": "Role and Policy name prefix",
        "Type": "String",
        "AllowedPattern": "^[a-zA-Z0-9-_]*$",
        "MaxLength": 32,
        "Default": ""
      }
    },
    "Resources": {
        "RHManagedOpenShiftInstallerRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": { "Fn::Join" : ["", [ { "Ref": "Prefix" }, "ManagedOpenShift-Installer-Role" ]] },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                               "AWS": { "Fn::Join" : [ "", [ "arn:aws:iam::", { "Ref": "RedHatAWSAccountID" }, ":role/RH-Managed-OpenShift-Installer" ]]}
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path": "/",
                "Tags": [
                    {"Key": "red-hat-managed", "Value": "true"},
                    {"Key": "rosa_openshift_version", "Value": { "Ref": "ROSAVersion" } },
                    {"Key": "rosa_role_prefix", "Value": { "Ref": "Prefix" } },
                    {"Key": "rosa_role_type", "Value": "installer"}
                ]
            }
        },
        "RHManagedOpenShiftSupportRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": { "Fn::Join" : ["", [ { "Ref": "Prefix" }, "ManagedOpenShift-Support-Role" ]] },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": { "Fn::Join": [ "", ["arn:aws:iam::", { "Ref": "RedHatAWSAccountID" }, ":role/RH-Technical-Support-Access" ] ]}
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path": "/",
                "Tags": [
                    {"Key": "red-hat-managed", "Value": "true"},
                    {"Key": "rosa_openshift_version", "Value": { "Ref": "ROSAVersion" } },
                    {"Key": "rosa_role_prefix", "Value": { "Ref": "Prefix" } },
                    {"Key": "rosa_role_type", "Value": "support"}
                ]
            }
        },
        "RHManagedOpenShiftControlPlaneRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": { "Fn::Join" : ["", [ { "Ref": "Prefix" }, "ManagedOpenShift-ControlPlane-Role" ]] },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                       "ec2.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path": "/",
                "Tags": [
                    {"Key": "red-hat-managed", "Value": "true"},
                    {"Key": "rosa_openshift_version", "Value": { "Ref": "ROSAVersion" } },
                    {"Key": "rosa_role_prefix", "Value": { "Ref": "Prefix" } },
                    {"Key": "rosa_role_type", "Value": "instance_controlplane"}
                ]
            }
        },
        "RHManagedOpenShiftWorkerRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": { "Fn::Join" : ["", [ { "Ref": "Prefix" }, "ManagedOpenShift-Worker-Role" ]] },
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                       "ec2.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path": "/",
                "Tags": [
                    {"Key": "red-hat-managed", "Value": "true"},
                    {"Key": "rosa_openshift_version", "Value": { "Ref": "ROSAVersion" } },
                    {"Key": "rosa_role_prefix", "Value": { "Ref": "Prefix" } },
                    {"Key": "rosa_role_type", "Value": "instance_worker"}
                ]
            }
        },
        "RHManagedOpenShiftInstallerPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "ManagedPolicyName": { "Fn::Join" : ["", [ { "Ref": "Prefix" }, "ManagedOpenShift-Installer-Role-Policy" ]] },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "*",
                            "Resource": "*"
                        }
                    ]
                },
                "Roles": [
                    {
                        "Ref": "RHManagedOpenShiftInstallerRole"
                    }
                ]
            }
        },
        "RHManagedOpenShiftSupportPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "ManagedPolicyName": { "Fn::Join" : ["", [ { "Ref": "Prefix" }, "ManagedOpenShift-Support-Role-Policy" ]] },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "*",
                            "Resource": "*"
                        }
                    ]
                },
                "Roles": [
                    {
                        "Ref": "RHManagedOpenShiftSupportRole"
                    }
                ]
            }
        },
        "RHManagedOpenShiftControlPlanePolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "ManagedPolicyName": { "Fn::Join" : ["", [ { "Ref": "Prefix" }, "ManagedOpenShift-ControlPlane-Role-Policy" ]] },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "*",
                            "Resource": "*"
                        }
                    ]
                },
                "Roles": [
                    {
                        "Ref": "RHManagedOpenShiftControlPlaneRole"
                    }
                ]
            }
        },
        "RHManagedOpenShiftWorkerPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "ManagedPolicyName": { "Fn::Join" : ["", [ { "Ref": "Prefix" }, "ManagedOpenShift-Worker-Role-Policy" ]] },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "*",
                            "Resource": "*"
                        }
                    ]
                },
                "Roles": [
                    {
                        "Ref": "RHManagedOpenShiftWorkerRole"
                    }
                ]
            }
        },
        "RHManagedOpenShiftCloudCredentialOperatorPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "ManagedPolicyName": { "Fn::Join" : ["", [ { "Ref": "Prefix" }, "ManagedOpenShift-openshift-cloud-credential-operator-cloud-crede" ]] },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "*",
                            "Resource": "*"
                        }
                    ]
                }
            }
        },
        "RHManagedOpenShiftMachineAPIOperatorPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "ManagedPolicyName": { "Fn::Join" : ["", [ { "Ref": "Prefix" }, "ManagedOpenShift-openshift-machine-api-aws-cloud-credentials" ]] },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "*",
                            "Resource": "*"
                        }
                    ]
                }
            }
        },
        "RHManagedOpenShiftImageRegistryOperatorPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "ManagedPolicyName": { "Fn::Join" : ["", [ { "Ref": "Prefix" }, "ManagedOpenShift-openshift-image-registry-installer-cloud-creden" ]] },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "*",
                            "Resource": "*"
                        }
                    ]
                }
            }
        },
        "RHManagedOpenShiftIngressOperatorPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "ManagedPolicyName": { "Fn::Join" : ["", [ { "Ref": "Prefix" }, "ManagedOpenShift-openshift-ingress-operator-cloud-credentials" ]] },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "*",
                            "Resource": "*"
                        }
                    ]
                }
            }
        },
        "RHManagedOpenShiftClusterCSIDriversEBSPolicy": {
            "Type": "AWS::IAM::ManagedPolicy",
            "Properties": {
                "ManagedPolicyName": { "Fn::Join" : ["", [ { "Ref": "Prefix" }, "ManagedOpenShift-openshift-cluster-csi-drivers-ebs-cloud-credent" ]] },
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "*",
                            "Resource": "*"
                        }
                    ]
                }
            }
        }
    },
	"Outputs" : {
        "CloudCredentialOperatorPolicyArn": {
			"Description" : "Cloud Credential Operator Policy Arn",
			"Value" :  { "Ref" : "RHManagedOpenShiftCloudCredentialOperatorPolicy" },
			"Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-CloudCredentialOperatorPolicyArn" }}
        },
        "MachineAPIOperatorPolicyArn": {
			"Description" : "Machine API Operator Policy Arn",
			"Value" :  { "Ref" : "RHManagedOpenShiftMachineAPIOperatorPolicy" },
			"Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-MachineAPIOperatorPolicyArn" }}
        },
        "ImageRegistryOperatorPolicyArn": {
			"Description" : "Image Registry Operator Policy Arn",
			"Value" :  { "Ref" : "RHManagedOpenShiftImageRegistryOperatorPolicy" },
			"Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-ImageRegistryOperatorPolicyArn" }}
        },
        "IngressOperatorPolicyArn": {
			"Description" : "Ingress Operator Policy Arn",
			"Value" :  { "Ref" : "RHManagedOpenShiftIngressOperatorPolicy" },
			"Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-IngressOperatorPolicyArn" }}
        },
        "ClusterCSIDriversEBSPolicyArn": {
			"Description" : "Cluster CSI Drivers EBS Policy Arn",
			"Value" :  { "Ref" : "RHManagedOpenShiftClusterCSIDriversEBSPolicy" },
			"Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-ClusterCSIDriversEBSPolicyArn" }}
        }
    }
}
