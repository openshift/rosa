{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Parameters" : {
      "AccountRolesStackName": {
        "Description": "Account Roles Stack Name",
        "Default": "account-roles",
        "Type": "String"
      },
      "OIDCProviderARN": {
        "Description": "OIDC Provider ARN",
        "Type": "String"
      },
      "IssuerURL": {
        "Description": "OIDC Issuer URL",
        "Type": "String"
      },
      "CloudCredentialOperatorSAName": {
        "Description": "Service Account Name",
        "Type": "String",
        "Default": "system:serviceaccount:openshift-cloud-credential-operator:cloud-credential-operator"
      },
      "MachineAPIOperatorSAName": {
        "Description": "Service Account Name",
        "Type": "String",
        "Default": "system:serviceaccount:openshift-machine-api:machine-api-controllers"
      },
      "ImageRegistryOperatorSAName": {
        "Description": "Service Account Name",
        "Type": "String",
        "Default": "\"system:serviceaccount:openshift-image-registry:cluster-image-registry-operator\" , \"system:serviceaccount:openshift-image-registry:registry\""
      },
      "IngressOperatorSAName": {
        "Description": "Service Account Name",
        "Type": "String",
        "Default": "system:serviceaccount:openshift-ingress-operator:ingress-operator"
      },
      "ClusterCSIDriverEBSSAName": {
        "Description": "Service Account Name",
        "Type": "String",
        "Default": "\"system:serviceaccount:openshift-cluster-csi-drivers:aws-ebs-csi-driver-operator\", \"system:serviceaccount:openshift-cluster-csi-drivers:aws-ebs-csi-driver-controller-sa\""
      },
      "CloudCredentialOperatorRoleName": {
        "Description": "Cloud Credential Operator Role Name",
        "Type": "String"
      },
      "CloudCredentialOperatorPolicyARN": {
        "Description": "Cloud Credential Operator IAM Policy ARN",
        "Type": "String"
      },
      "MachineAPIOperatorRoleName": {
        "Description": "Machine API Operator Role Name",
        "Type": "String"
      },
      "MachineAPIOperatorPolicyARN": {
        "Description": "Machine API Operator IAM Policy ARN",
        "Type": "String"
      },
      "ImageRegistryOperatorRoleName": {
        "Description": "Image Registry Operator Role Name",
        "Type": "String"
      },
      "ImageRegistryOperatorPolicyARN": {
        "Description": "Image Registry Operator IAM Policy ARN",
        "Type": "String"
      },
      "IngressOperatorRoleName": {
        "Description": "Ingress Operator Role Name",
        "Type": "String"
      },
      "IngressOperatorPolicyARN": {
        "Description": "Ingress Operator IAM Policy ARN",
        "Type": "String"
      },
      "ClusterCSIDriverEBSRoleName": {
        "Description": "Cluster CSI Driver EBS Role Name",
        "Type": "String"
      },
      "ClusterCSIDriverEBSPolicyARN": {
        "Description": "Cluster CSI Driver EBS Policy ARN",
        "Type": "String"
      }
    },
    "Resources": {
        "CloudCredentialOperatorRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
            	"RoleName": { "Ref": "CloudCredentialOperatorRoleName" },
                "AssumeRolePolicyDocument": {
					"Fn::Sub": "{\"Version\": \"2012-10-17\",\"Statement\":[{\"Effect\": \"Allow\",\"Principal\":{\"Federated\": [ \"${OIDCProviderARN}\" ]},\"Action\": [\"sts:AssumeRoleWithWebIdentity\"],\"Condition\": {\"StringEquals\": {\"${IssuerURL}:sub\":  \"${CloudCredentialOperatorSAName}\"} } } ] }"
                },
                "ManagedPolicyArns": [{ "Ref": "CloudCredentialOperatorPolicyARN" }],
                "Tags":
					[
						{"Key": "red-hat-managed", "Value": "true"}
					]
				}
        },
        "MachineAPIOperatorRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
            	"RoleName": { "Ref": "MachineAPIOperatorRoleName" },
                "AssumeRolePolicyDocument": {
					"Fn::Sub": "{\"Version\": \"2012-10-17\",\"Statement\":[{\"Effect\": \"Allow\",\"Principal\":{\"Federated\": [ \"${OIDCProviderARN}\" ]},\"Action\": [\"sts:AssumeRoleWithWebIdentity\"],\"Condition\": {\"StringEquals\": {\"${IssuerURL}:sub\":  \"${MachineAPIOperatorSAName}\"} } } ] }"
                },
                "ManagedPolicyArns": [{"Ref": "MachineAPIOperatorPolicyARN"}],
                "Tags": [
            	    {"Key": "red-hat-managed", "Value": "true"}
            	]
            }
        },
        "ImageRegistryOperatorRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
            	"RoleName": { "Ref": "ImageRegistryOperatorRoleName" },
                "AssumeRolePolicyDocument": {
                    "Fn::Sub": "{\"Version\": \"2012-10-17\",\"Statement\": [{\"Effect\": \"Allow\",\"Principal\": {\"Federated\": [\"${OIDCProviderARN}\" ]},\"Action\": [\"sts:AssumeRoleWithWebIdentity\"],\"Condition\": {\"StringEquals\": {\"${IssuerURL}:sub\": [ \"system:serviceaccount:openshift-image-registry:cluster-image-registry-operator\", \"system:serviceaccount:openshift-image-registry:registry\" ] } } }] }"
                },
                "ManagedPolicyArns": [{ "Ref": "ImageRegistryOperatorPolicyARN" }],
                "Tags": [
            	    {"Key": "red-hat-managed", "Value": "true"}
            	]
            }
        },
        "IngressOperatorRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
            	"RoleName": { "Ref": "IngressOperatorRoleName" },
                "AssumeRolePolicyDocument": {
					"Fn::Sub": "{\"Version\": \"2012-10-17\",\"Statement\":[{\"Effect\": \"Allow\",\"Principal\":{\"Federated\": [ \"${OIDCProviderARN}\" ]},\"Action\": [\"sts:AssumeRoleWithWebIdentity\"],\"Condition\": {\"StringEquals\": {\"${IssuerURL}:sub\":  \"${IngressOperatorSAName}\"} } } ] }"
                },
                "ManagedPolicyArns": [{ "Ref": "IngressOperatorPolicyARN"}],
                "Tags": [
                	{"Key": "red-hat-managed", "Value": "true"}
            	]
            }
        },
        "ClusterCSIDriverEBSRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
            	"RoleName": { "Ref": "ClusterCSIDriverEBSRoleName" },
                "AssumeRolePolicyDocument": {
                "ManagedPolicyArns": [{ "Ref": "ClusterCSIDriverEBSPolicyARN" }],
                },
                "ManagedPolicyArns": [{ "Ref": "NetworkConfigControllerPolicyARN" }],
            	"Tags": [
            	    {"Key": "red-hat-managed", "Value": "true"}
            	]
            }
        }
    },	
    "Outputs" : {
        "CloudCredentialOperatorRoleArn": {
			"Description" : "Cloud Credential Operator Role Arn",
			"Value" :  { "Fn::GetAtt" : ["CloudCredentialOperatorRole", "Arn"] },
			"Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-CloudCredentialOperatorRoleArn" }}
	  }
	}
}
