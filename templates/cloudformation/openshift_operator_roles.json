{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Parameters" : {
      "AccountRolesStackName": {
        "Description": "Account Roles Stack Name",
        "Default": "account-roles",
        "Type": "String"
      },
      "OIDCProviderARN": {
        "Description": "OIDC Provider ARN",
        "Type": "String"
      },
      "IssuerURL": {
        "Description": "OIDC Issuer URL",
        "Type": "String"
      },
      "CloudCredentialOperatorSAName": {
        "Description": "Service Account Name",
        "Type": "String",
        "Default": "system:serviceaccount:openshift-cloud-credential-operator:cloud-credential-operator"
      },
      "MachineAPIOperatorSAName": {
        "Description": "Service Account Name",
        "Type": "String",
        "Default": "system:serviceaccount:openshift-machine-api:machine-api-controllers"
      },
      "ImageRegistryOperatorSAName": {
        "Description": "Service Account Name",
        "Type": "CommaDelimitedList",
        "Default": "system:serviceaccount:openshift-image-registry:cluster-image-registry-operator, system:serviceaccount:openshift-image-registry:registry"
      },
      "IngressOperatorSAName": {
        "Description": "Service Account Name",
        "Type": "String",
        "Default": "system:serviceaccount:openshift-ingress-operator:ingress-operator"
      },
      "ClusterCSIDriverEBSSAName": {
        "Description": "Service Account Name",
        "Type": "CommaDelimitedList",
        "Default": "system:serviceaccount:openshift-cluster-csi-drivers:aws-ebs-csi-driver-operator, system:serviceaccount:openshift-cluster-csi-drivers:aws-ebs-csi-driver-controller-sa"
      },
      "CloudCredentialOperatorRoleName": {
        "Description": "OIDC Provider ARN",
        "Type": "String"
      },
      "MachineAPIOperatorRoleName": {
        "Description": "OIDC Provider ARN",
        "Type": "String"
      },
      "ImageRegistryOperatorRoleName": {
        "Description": "OIDC Provider ARN",
        "Type": "String"
      },
      "IngressOperatorRoleName": {
        "Description": "OIDC Provider ARN",
        "Type": "String"
      },
      "ClusterCSIDriverEBSRoleName": {
        "Description": "OIDC Provider ARN",
        "Type": "String"
      }
    },
    "Resources": {
        "CloudCredentialOperatorRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
            	"RoleName": { "Ref": "CloudCredentialOperatorRoleName" },
                "AssumeRolePolicyDocument": {
					"Fn::Sub": "{\"Version\": \"2012-10-17\",\"Statement\":[{\"Effect\": \"Allow\",\"Principal\":{\"Federated\": [ \"${OIDCProviderARN}\" ]},\"Action\": [\"sts:AssumeRoleWithWebIdentity\"],\"Condition\": {\"StringEquals\": {\"${IssuerURL}:sub\":  \"${CloudCredentialOperatorSAName}\"} } } ] }"
                },
                "ManagedPolicyArns": [{ "Fn::ImportValue": {"Fn::Sub": "${AccountRolesStackName}-CloudCredentialOperatorPolicyArn"} }],
                "Tags":
					[
						{"Key": "red-hat-managed", "Value": "true"}
					]
				}
        },
        "MachineAPIOperatorRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
            	"RoleName": { "Ref": "MachineAPIOperatorRoleName" },
                "AssumeRolePolicyDocument": {
					"Fn::Sub": "{\"Version\": \"2012-10-17\",\"Statement\":[{\"Effect\": \"Allow\",\"Principal\":{\"Federated\": [ \"${OIDCProviderARN}\" ]},\"Action\": [\"sts:AssumeRoleWithWebIdentity\"],\"Condition\": {\"StringEquals\": {\"${IssuerURL}:sub\":  \"${MachineAPIOperatorSAName}\"} } } ] }"
                },
                "ManagedPolicyArns": [{ "Fn::ImportValue": {"Fn::Sub": "${AccountRolesStackName}-MachineAPIOperatorPolicyArn"} }],
                "Tags": [
            	    {"Key": "red-hat-managed", "Value": "true"}
            	]
            }
        },
        "ImageRegistryOperatorRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
            	"RoleName": { "Ref": "ImageRegistryOperatorRoleName" },
                "AssumeRolePolicyDocument": {
                    "Fn::Sub": [ "{\"Version\": \"2012-10-17\",\"Statement\": [{\"Effect\": \"Allow\",\"Principal\": {\"Federated\": [\"${OIDCProviderARN}\" ]},\"Action\": [\"sts:AssumeRoleWithWebIdentity\"],\"Condition\": {\"StringEquals\": {\"${IssuerURL}:sub\": [\"${ImageRegistrySAName}\"] } } }] }", { "ImageRegistrySAName": { "Fn::Join": [ ",", {"Ref": "ImageRegistryOperatorSAName"} ] } } ]
                },
                "ManagedPolicyArns": [{ "Fn::ImportValue": {"Fn::Sub": "${AccountRolesStackName}-ImageRegistryOperatorPolicyArn"} }],
                "Tags": [
            	    {"Key": "red-hat-managed", "Value": "true"}
            	]
            }
        },
        "IngressOperatorRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
            	"RoleName": { "Ref": "IngressOperatorRoleName" },
                "AssumeRolePolicyDocument": {
					"Fn::Sub": "{\"Version\": \"2012-10-17\",\"Statement\":[{\"Effect\": \"Allow\",\"Principal\":{\"Federated\": [ \"${OIDCProviderARN}\" ]},\"Action\": [\"sts:AssumeRoleWithWebIdentity\"],\"Condition\": {\"StringEquals\": {\"${IssuerURL}:sub\":  \"${IngressOperatorSAName}\"} } } ] }"
                },
                "ManagedPolicyArns": [{ "Fn::ImportValue": {"Fn::Sub": "${AccountRolesStackName}-IngressOperatorPolicyArn"} }],
                "Tags": [
                	{"Key": "red-hat-managed", "Value": "true"}
            	]
            }
        },
        "ClusterCSIDriverEBSRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
            	"RoleName": { "Ref": "ClusterCSIDriverEBSRoleName" },
                "AssumeRolePolicyDocument": {
                "Fn::Sub": [ "{\"Version\": \"2012-10-17\",\"Statement\": [{\"Effect\": \"Allow\",\"Principal\": {\"Federated\": [\"${OIDCProviderARN}\" ]},\"Action\": [\"sts:AssumeRoleWithWebIdentity\"],\"Condition\": {\"StringEquals\": {\"${IssuerURL}:sub\": [ \"${CSIDriverEBSSAName}\" ] } } }] }", { "CSIDriverEBSSAName": { "Fn::Join": [ ",", {"Ref": "ClusterCSIDriverEBSSAName"} ] } } ]
                },
                "ManagedPolicyArns": [{ "Fn::ImportValue": {"Fn::Sub": "${AccountRolesStackName}-ClusterCSIDriversEBSPolicyArn"} }],
            	"Tags": [
            	    {"Key": "red-hat-managed", "Value": "true"}
            	]
            }
        }
    },
	"Outputs" : {
        "CloudCredentialOperatorRoleArn": {
			"Description" : "Cloud Credential Operator Role Arn",
			"Value" :  { "Fn::GetAtt" : ["CloudCredentialOperatorRole", "Arn"] },
			"Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-CloudCredentialOperatorRoleArn" }}
	  }
	}
}
